#include <alsa/asoundlib.h>
#include <iostream>
#include "AlsaEffects/include/AlsaBufferConverter.h"
#include "AlsaEffects/include/EffectsManager.h"
#include "AlsaEffects/include/PcmAudioCapture.h"
#include "AlsaEffects/include/PcmAudioPlayback.h"
#include <memory>
#include "AlsaEffects/include/EffectBase.h"

int main()
{
    // uint8_t originalData[] = { 0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 ,
    //                   0x7F, 0xFF, 0xFF, 0x40, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x00, 0x00 };
    
    // uint8_t originalData[] = { 0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00 ,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00,
    //                                0x7F, 0xFF, 0x40, 0x00, 0xc0, 0x00, 0x80, 0x00 };
    
    // uint8_t finalData[176];
    // uint16_t numOfFrames = sizeof(originalData)/4;

	// AlsaBufferConverter* test = new AlsaBufferConverter;

    // ChannelSamples* initial_data = new ChannelSamples(numOfFrames);

    // test->getSamples(initial_data, originalData);

    // for (size_t i = 0; i < numOfFrames; ++i)
    // {
    //     printf("%d: %d \t %d\n",i, initial_data->getLeftElement(i), initial_data->getRightElement(i));
    // }

    // test->getBuffer(finalData,initial_data);

    // for (size_t i = 0; i < sizeof(originalData); i+=4)
    // {
    //     printf("%02X %02X %02X %02X\n", finalData[i],finalData[i+1],finalData[i+2],finalData[i+3]);
    // }

    // delete test;
    // delete initial_data;

    //////////// Program Configuration START ////////////

    // Optimum Value = 9600;
    snd_pcm_uframes_t framesPerBuffer = 9600;

    // Options: SND_PCM_FORMAT_S16_LE, SND_PCM_FORMAT_S16_BE,  SND_PCM_FORMAT_S24_LE, SND_PCM_FORMAT_S24_BE
    snd_pcm_format_t format = SND_PCM_FORMAT_S16_LE; 

    // Anything works
    unsigned int sampleRate = 96000;

    //////////// Program Configuration END ////////////

    eEndianness endian;
    uint8_t bytesPerSample;
    switch (format)
    {
    case SND_PCM_FORMAT_S16_LE:
        endian = eLITTLE;
        bytesPerSample = 2;
        break;
    case SND_PCM_FORMAT_S16_BE:
        endian = eBIG;
        bytesPerSample = 2;
        break;
    case SND_PCM_FORMAT_S24_LE:
        endian = eLITTLE;
        bytesPerSample = 3;
        break;
    case SND_PCM_FORMAT_S24_BE:
        endian = eBIG;
        bytesPerSample = 3;
        break;
    default:
        fprintf(stderr, "Invalid Format. Ending Program.");
        return 0;
        break;
    }

    EffectsManager* em = new EffectsManager(endian, bytesPerSample, framesPerBuffer);

    PcmAudioPlayback* play = new PcmAudioPlayback("default", format, framesPerBuffer, sampleRate);

    PcmAudioCapture* cap = new PcmAudioCapture("hw:1,1", format, framesPerBuffer, sampleRate);

    cap->registerCallback(em);
    em->registerCallback(play);

    cap->start();

    getchar();

    printf("\ndeleting cap\n");
    delete cap;
    printf("\ndeleting em\n");
    delete em;
    printf("\ndeleting play\n");
    delete play;
    return 0;
}
